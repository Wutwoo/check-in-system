<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>潤森鑫打卡系統</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        #clock {
            font-size: 24px;
            margin-bottom: 20px;
        }
        select, button {
            padding: 10px;
            font-size: 16px;
            margin: 10px;
        }
        #records {
            margin-top: 20px;
            text-align: left;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        #exportBtn {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        #exportBtn:hover {
            background-color: #45a049;
        }
        #checkInBtn {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        #checkInBtn:hover {
            background-color: #0056b3;
        }
        #errorMsg {
            color: red;
            margin-top: 10px;
            display: none;
        }
        #successMsg {
            color: green;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <h1>潤森鑫打卡系統</h1>
    <div id="clock"></div>
    <div id="errorMsg"></div>
    <div id="successMsg"></div>
    
    <label for="shift">班別：</label>
    <select id="shift" onchange="updateNames()">
        <option value="早班">早班</option>
        <option value="晚班">晚班</option>
        <option value="客服">客服</option>
    </select>
    
    <label for="name">姓名：</label>
    <select id="name"></select>
    
    <label for="type">打卡項目：</label>
    <select id="type">
        <option value="上班">上班</option>
        <option value="下班">下班</option>
        <option value="吃飯">吃飯</option>
        <option value="結束吃飯">結束吃飯</option>
        <option value="休息">休息</option>
        <option value="結束休息">結束休息</option>
        <option value="廁所">廁所</option>
        <option value="抽菸">抽菸</option>
        <option value="返回座位">返回座位</option>
        <option value="事假">事假</option>
        <option value="病假">病假</option>
        <option value="銷假上班">銷假上班</option>
    </select>
    
    <button id="checkInBtn" onclick="checkIn()">打卡</button>
    
    <div id="records">
        <h2>打卡記錄</h2>
        <button id="exportBtn" onclick="exportToCSV()">匯出報表 (CSV)</button>
        <table>
            <thead>
                <tr>
                    <th>姓名</th>
                    <th>班別</th>
                    <th>項目</th>
                    <th>時間</th>
                </tr>
            </thead>
            <tbody id="recordTable"></tbody>
        </table>
    </div>

    <script>
        // 員工名單
        const employees = {
            早班: ['來財', '南風', '胖子', '大飛', '小柒', '曹操 (組長)'],
            晚班: ['夢子', '安妮亞', '鹿丸', '江海', '馬斯克', '傑諾', '白馬', '柳丁', '冬瓜', '紅丸', '杜月笙 (組長)', '五條悟 (組長)'],
            客服: ['星空', '森鋒']
        };

        // 動態更新姓名下拉選單
        function updateNames() {
            const shift = document.getElementById('shift').value;
            const nameSelect = document.getElementById('name');
            nameSelect.innerHTML = '';
            employees[shift].forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                nameSelect.appendChild(option);
            });
        }

        // 更新當前時間（台灣時區）
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-TW', { 
                timeZone: 'Asia/Taipei',
                year: 'numeric', month: '2-digit', day: '2-digit', 
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false 
            });
            document.getElementById('clock').textContent = `當前時間: ${timeString}`;
        }

        // 資料庫 URL
        const DATABASE_URL = 'https://script.google.com/macros/s/AKfycbzDm81N276SYIzDkEJaFHydg72Kh1OMVShVAjWfLAsh-_Girx625VWNztALr1TDOWiL/exec';

        // 顯示訊息
        function showMessage(elementId, message, isError = false) {
            const msgElement = document.getElementById(elementId);
            msgElement.textContent = message;
            msgElement.style.display = 'block';
            msgElement.style.color = isError ? 'red' : 'green';
            setTimeout(() => { msgElement.style.display = 'none'; }, 5000);
        }

        // 防抖機制：限制 5 秒內只能打卡一次
        let lastCheckInTime = 0;
        const CHECKIN_COOLDOWN = 5000; // 5 秒冷卻時間

        // 打卡功能
        async function checkIn() {
            const now = Date.now();
            if (now - lastCheckInTime < CHECKIN_COOLDOWN) {
                showMessage('errorMsg', '請等待 5 秒後再次打卡', true);
                return;
            }

            const shift = document.getElementById('shift').value;
            const name = document.getElementById('name').value;
            const type = document.getElementById('type').value;
            if (!shift || !name || !type) {
                showMessage('errorMsg', '請選擇班別、姓名和打卡項目', true);
                return;
            }

            // 確認提示
            if (!confirm(`確定要為 ${name} 打卡 ${type}？`)) {
                return;
            }

            const timeString = new Date().toLocaleString('zh-TW', { 
                timeZone: 'Asia/Taipei',
                year: 'numeric', month: '2-digit', day: '2-digit', 
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false 
            });

            const record = { shift, name, type, time: timeString };

            try {
                const response = await fetch(DATABASE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(record)
                });
                if (!response.ok && response.status !== 0) {
                    throw new Error(`打卡失敗: HTTP ${response.status}`);
                }
                lastCheckInTime = now; // 更新最後打卡時間
                await loadRecords();
                showMessage('successMsg', '打卡成功，已儲存到資料庫');
            } catch (error) {
                showMessage('errorMsg', `打卡失敗: ${error.message}`, true);
                console.error('打卡失敗:', error);
            }
        }

        // 載入打卡記錄
        async function loadRecords() {
            try {
                const response = await fetch(`${DATABASE_URL}?action=get`, { method: 'GET' });
                if (!response.ok) throw new Error(`無法載入記錄: HTTP ${response.status}`);
                const records = await response.json();
                const recordTable = document.getElementById('recordTable');
                recordTable.innerHTML = '';
                records.forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${record.name}</td>
                        <td>${record.shift}</td>
                        <td>${record.type}</td>
                        <td>${record.time}</td>
                    `;
                    recordTable.appendChild(row);
                });
                return records;
            } catch (error) {
                showMessage('errorMsg', `載入記錄失敗: ${error.message}`, true);
                console.error('載入記錄失敗:', error);
                return [];
            }
        }

        // 匯出報表為 CSV
        async function exportToCSV() {
            const records = await loadRecords();
            if (records.length === 0) {
                showMessage('errorMsg', '無記錄可匯出', true);
                return;
            }

            const headers = ['姓名', '班別', '項目', '時間'];
            const csvRows = [headers.join(',')];
            records.forEach(record => {
                const row = [
                    `"${record.name}"`,
                    `"${record.shift}"`,
                    `"${record.type}"`,
                    `"${record.time}"`
                ];
                csvRows.push(row.join(','));
            });
            const csvContent = csvRows.join('\n');

            const blob = new Blob([`\ufeff${csvContent}`], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `潤森鑫_打卡記錄_${new Date().toLocaleDateString('zh-TW', { timeZone: 'Asia/Taipei' }).replace(/\//g, '-')}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
        }

        // 初始化
        updateNames();
        setInterval(updateClock, 1000);
        updateClock();
        loadRecords();
    </script>
</body>
</html>