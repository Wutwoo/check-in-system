<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>潤森鑫打卡系統</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        #clock {
            font-size: 24px;
            margin-bottom: 20px;
        }
        select, button {
            padding: 10px;
            font-size: 16px;
            margin: 10px;
        }
        #records {
            margin-top: 20px;
            text-align: left;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        #exportBtn {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        #exportBtn:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <h1>潤森鑫打卡系統</h1>
    <div id="clock"></div>
    
    <label for="shift">班別：</label>
    <select id="shift" onchange="updateNames()">
        <option value="早班">早班</option>
        <option value="晚班">晚班</option>
        <option value="客服">客服</option>
    </select>
    
    <label for="name">姓名：</label>
    <select id="name"></select>
    
    <h2>打卡項目</h2>
    <button onclick="checkIn('上班')">上班</button>
    <button onclick="checkIn('下班')">下班</button>
    <button onclick="checkIn('吃飯')">吃飯</button>
    <button onclick="checkIn('結束吃飯')">結束吃飯</button>
    <button onclick="checkIn('廁所')">廁所</button>
    <button onclick="checkIn('抽菸')">抽菸</button>
    <button onclick="checkIn('返回座位')">返回座位</button>
    <button onclick="checkIn('事假')">事假</button>
    <button onclick="checkIn('病假')">病假</button>
    <button onclick="checkIn('銷假上班')">銷假上班</button>
    
    <div id="records">
        <h2>打卡記錄</h2>
        <button id="exportBtn" onclick="exportToCSV()">匯出報表 (CSV)</button>
        <table>
            <thead>
                <tr>
                    <th>姓名</th>
                    <th>班別</th>
                    <th>項目</th>
                    <th>時間</th>
                </tr>
            </thead>
            <tbody id="recordTable"></tbody>
        </table>
    </div>

    <script>
        // 員工名單
        const employees = {
            早班: ['來財', '南風', '胖子', '大飛', '小柒', '曹操 (組長)'],
            晚班: ['夢子', '安妮亞', '鹿丸', '江海', '馬斯克', '傑諾', '白馬', '柳丁', '冬瓜', '紅丸', '杜月笙 (組長)', '五條悟 (組長)'],
            客服: ['星空', '森鋒']
        };

        // 動態更新姓名下拉選單
        function updateNames() {
            const shift = document.getElementById('shift').value;
            const nameSelect = document.getElementById('name');
            nameSelect.innerHTML = '';
            employees[shift].forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                nameSelect.appendChild(option);
            });
        }

        // 更新當前時間（台灣時區）
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-TW', { 
                timeZone: 'Asia/Taipei', // 明確指定台灣時區
                year: 'numeric', month: '2-digit', day: '2-digit', 
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false 
            });
            document.getElementById('clock').textContent = `當前時間: ${timeString}`;
        }

        // 替換為您的 Google Apps Script 部署 URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/<您的腳本ID>/exec';

        // 載入打卡記錄
        async function loadRecords() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=get`);
                const records = await response.json();
                const recordTable = document.getElementById('recordTable');
                recordTable.innerHTML = '';
                records.forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${record.name}</td>
                        <td>${record.shift}</td>
                        <td>${record.type}</td>
                        <td>${record.time}</td>
                    `;
                    recordTable.appendChild(row);
                });
                return records;
            } catch (error) {
                console.error('載入記錄失敗:', error);
                return [];
            }
        }

        // 打卡功能
        async function checkIn(type) {
            const shift = document.getElementById('shift').value;
            const name = document.getElementById('name').value;
            const now = new Date();
            const timeString = now.toLocaleString('zh-TW', { 
                timeZone: 'Asia/Taipei', // 明確指定台灣時區
                year: 'numeric', month: '2-digit', day: '2-digit', 
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false 
            });

            const record = { shift, name, type, time: timeString };

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(record)
                });
                loadRecords();
            } catch (error) {
                console.error('打卡失敗:', error);
            }
        }

        // 匯出報表為 CSV
        async function exportToCSV() {
            const records = await loadRecords();
            if (records.length === 0) {
                alert('無記錄可匯出');
                return;
            }

            const headers = ['姓名', '班別', '項目', '時間'];
            const csvRows = [headers.join(',')];
            records.forEach(record => {
                const row = [
                    `"${record.name}"`,
                    `"${record.shift}"`,
                    `"${record.type}"`,
                    `"${record.time}"`
                ];
                csvRows.push(row.join(','));
            });
            const csvContent = csvRows.join('\n');

            const blob = new Blob([`\ufeff${csvContent}`], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `潤森鑫_打卡記錄_${new Date().toLocaleDateString('zh-TW').replace(/\//g, '-')}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
        }

        // 初始化
        updateNames();
        setInterval(updateClock, 1000);
        updateClock();
        loadRecords();
    </script>
</body>
</html>