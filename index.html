<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>潤森鑫打卡系統 (v5.5 最终修正)</title>
<style>
body{font-family: Arial, sans-serif;max-width: 800px;margin: 0 auto;padding: 20px;text-align: center;}
#clock{font-size: 24px;margin-bottom: 20px;}
select,button{padding: 10px;font-size: 16px;margin: 10px;}
#records{margin-top: 20px;text-align: left;max-height: 400px;overflow-y: auto;}
table{width: 100%;border-collapse: collapse;}
th,td{border: 1px solid #ddd;padding: 8px;text-align: center;}
th{background-color: #f2f2f2;position: sticky;top: 0;}
#exportBtn{background-color: #4CAF50;color: white;border: none;cursor: pointer;}
#exportBtn:hover{background-color: #45a049;}
#checkInBtn{background-color: #007bff;color: white;border: none;cursor: pointer;}
#checkInBtn:hover{background-color: #0056b3;}
#errorMsg{color: red;margin-top: 10px;display: none;}
#successMsg{color: green;margin-top: 10px;display: none;}
#filterControls{text-align: left;margin-bottom: 15px;}
</style>
</head>
<body>
<h1>潤森鑫打卡系統</h1>
<div id="clock"></div><div id="errorMsg"></div><div id="successMsg"></div>

<label for="group">組別：</label><select id="group" onchange="updateNames()" autocomplete="off"><option value="天狼組">天狼組</option><option value="洋天組">洋天組</option><option value="策天組">策天組</option><option value="新增">新增</option><option value="客服">客服</option></select>
<label for="name">姓名：</label><select id="name" autocomplete="off"></select>
<label for="type">打卡項目：</label><select id="type" autocomplete="off"><option value="上班">上班</option><option value="下班">下班</option><option value="吃飯">吃飯</option><option value="結束吃飯">結束吃飯</option><option value="休息">休息</option><option value="結束休息">結束休息</option><option value="廁所">廁所</option><option value="抽菸">抽菸</option><option value="返回座位">返回座位</option><option value="事假">事假</option><option value="病假">病假</option><option value="銷假上班">銷假上班</option></select>
<button id="checkInBtn" onclick="checkIn()">打卡</button>
<div id="records"><h2>打卡記錄 (僅顯示過去 24 小時)</h2><div id="filterControls"><label for="filterGroup">按組別篩選：</label><select id="filterGroup" onchange="loadRecords()"></select></div><button id="exportBtn" onclick="exportToCSV()">匯出報表 (CSV)</button><table><thead><tr><th>姓名</th><th>組別</th><th>項目</th><th>時間</th><th>IP 地址</th></tr></thead><tbody id="recordTable"></tbody></table></div>

<script>
const employees={天狼組:['曹操 (組長)','來財','南風','胖子','大飛','小柒','馬超'],洋天組:['杜月笙 (組長)','江海','馬斯克','白馬'],策天組:['五條悟 (組長)','夢子','安妮亞','鹿丸','傑諾','柳丁'],新增:['紅丸','冬瓜'],客服:['星空','森鋒']};
const DATABASE_URL='https://script.google.com/macros/s/AKfycbzDm81N276SYIzDkEJaFHydg72Kh1OMVShVAjWfLAsh-_Girx625VWNztALr1TDOWiL/exec';

let recordsPromiseResolver = null;
function handleData(data) {
  console.log("成功從後端接收到的原始資料:", data);
  if (recordsPromiseResolver) {
    recordsPromiseResolver(data);
    recordsPromiseResolver = null;
  }
}

async function fetchAndFilterRecords() {
  return new Promise((resolve, reject) => {
    recordsPromiseResolver = (data) => {
      if (data.error) {
        console.error("後端返回錯誤:", data.error);
        reject(new Error(data.error));
        return;
      }
      const selectedGroup = document.getElementById('filterGroup').value;
      const groupFilteredRecords = selectedGroup === '全部' ? data : data.filter(record => record.shift === selectedGroup);
      const now = new Date();
      const twentyFourHoursAgo = new Date(now.getTime() - (24 * 60 * 60 * 1000));
      
      const finalRecords = groupFilteredRecords.filter(record => {
        if (!record.time) return false;
        // *** 最终修正 ***
        const recordTime = new Date(record.time);
        return recordTime >= twentyFourHoursAgo;
      });

      console.log("经过 24 小时筛选后，剩余 " + finalRecords.length + " 笔记录");
      resolve(finalRecords);
    };
    const script = document.createElement('script');
    script.src = DATABASE_URL;
    script.onerror = () => { reject(new Error('JSONP request failed')); };
    document.body.appendChild(script);
  });
}

async function loadRecords() {
  try {
    const records = await fetchAndFilterRecords();
    records.sort((a, b) => {
      // *** 最终修正 ***
      const timeA = new Date(a.time);
      const timeB = new Date(b.time);
      return timeB - timeA;
    });
    const recordTable = document.getElementById('recordTable');
    recordTable.innerHTML = '';
    records.forEach(record => {
      // *** 最终修正 ***
      const time = new Date(record.time);
      const formattedTime = time.toLocaleString('zh-TW', {
        timeZone: 'Asia/Taipei',
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
      });
      const row = document.createElement('tr');
      row.innerHTML = `<td>${record.name}</td><td>${record.shift}</td><td>${record.type}</td><td>${formattedTime}</td><td>${record.ip || 'N/A'}</td>`;
      recordTable.appendChild(row);
    });
    return records;
  } catch (error) {
    console.error("Load records failed:", error);
    showMessage('errorMsg', `载入记录失败: ${error.message}`, true);
    return [];
  }
}

function updateNames(){const a=document.getElementById("group").value;const b=document.getElementById("name");b.innerHTML="";employees[a].forEach(c=>{const d=document.createElement("option");d.value=c;d.textContent=c;b.appendChild(d)})}
function populateFilter(){const a=document.getElementById("filterGroup");a.innerHTML='<option value="全部">全部</option>';Object.keys(employees).forEach(b=>{const c=document.createElement("option");c.value=b;c.textContent=b;a.appendChild(c)})}
function updateClock(){const a=(new Date).toLocaleString("zh-TW",{timeZone:"Asia/Taipei",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1});document.getElementById("clock").textContent=`當前時間: ${a}`}
function showMessage(a,b,c=!1){const d=document.getElementById(a);d.textContent=b;d.style.display="block";d.style.color=c?"red":"green";setTimeout(()=>{d.style.display="none"},5e3)}
async function getIPAddress(){const a=["https://api.ipify.org?format=json","https://ipapi.co/json/","https://ipinfo.io/json"];for(const b of a)try{const c=await fetch(b,{signal:AbortSignal.timeout(3e3)});if(!c.ok)throw new Error(`HTTP ${c.status}`);const d=await c.json();return d.ip||d.query||"N/A"}catch(c){console.warn(`IP API ${b} 失敗: ${c.message}`)}return showMessage("errorMsg","無法獲取 IP 地址，請檢查網路連線",!0),"N/A"}
async function checkIn(){const a=document.getElementById("group").value;const b=document.getElementById("name").value;const c=document.getElementById("type").value;if(!a||!b||!c){showMessage("errorMsg","請選擇組別、姓名和打卡項目",!0);return}if(!confirm(`確定要為 ${b} 打卡 ${c}？`))return;const d=document.getElementById("clock").textContent.replace("當前時間: ","");const e=await getIPAddress();if("N/A"===e){showMessage("errorMsg","無法獲取 IP 地址，打卡失敗",!0);return}const f={shift:a,name:b,type:c,time:d,ip:e};try{await fetch(DATABASE_URL,{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(f)}),await loadRecords(),showMessage("successMsg","打卡成功，已儲存到資料庫")}catch(g){showMessage("errorMsg",`打卡失敗: ${g.message}`,!0),console.error("打卡失敗:",g)}}
async function exportToCSV(){const a=await loadRecords();if(0===a.length){showMessage("errorMsg","無記錄可匯出",!0);return}const b=["姓名","組別","項目","時間","IP 地址"],c=[b.join(",")];a.forEach(d=>{const e=(new Date(d.time)).toLocaleString("zh-TW",{timeZone:"Asia/Taipei",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}),f=[`"${d.name}"`,`"${d.shift}"`,`"${d.type}"`,`"${e}"`,`"${d.ip||"N/A"}"`];c.push(f.join(","))});const d=c.join("\n"),e=new Blob(["\uFEFF"+d],{type:"text/csv;charset=utf-8;"}),f=window.URL.createObjectURL(e),g=document.createElement("a"),h=(new Date).toLocaleDateString("zh-TW",{timeZone:"Asia/Taipei"}).replace(/\//g,"-");g.href=f;g.download=`潤森鑫_打卡記錄_${h}.csv`;document.body.appendChild(g);g.click();document.body.removeChild(g);window.URL.revokeObjectURL(f)}
function startAutoRefresh(){setInterval(function(){"visible"===document.visibilityState&&loadRecords()},3e4)}
updateNames();populateFilter();setInterval(updateClock,1e3);updateClock();loadRecords();startAutoRefresh();
</script>
</body>
</html>