<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>潤森鑫打卡系統 (v9.5 最終修復版)</title>
<style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; text-align: center; }
    #clock { font-size: 24px; margin-bottom: 20px; }
    select, button { padding: 10px; font-size: 16px; margin: 10px; }
    #records { margin-top: 20px; text-align: left; max-height: 400px; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; position: sticky; top: 0; }
    #exportBtn { background-color: #4CAF50; color: white; border: none; cursor: pointer; }
    #exportBtn:hover { background-color: #45a049; }
    #checkInBtn { background-color: #007bff; color: white; border: none; cursor: pointer; }
    #checkInBtn:hover { background-color: #0056b3; }
    #errorMsg { color: red; margin-top: 10px; display: none; }
    #successMsg { color: green; margin-top: 10px; display: none; }
    #filterControls { text-align: left; margin-bottom: 15px; }
</style>
</head>
<body>
    <h1>潤森鑫打卡系統</h1>
    <div id="clock"></div>
    <div id="errorMsg"></div>
    <div id="successMsg"></div>

    <label for="group">組別：</label>
    <select id="group" onchange="updateNames()" autocomplete="off">
        <option value="天狼組">天狼組</option>
        <option value="洋天組">洋天組</option>
        <option value="策天組">策天組</option>
        <option value="新增">新增</option>
        <option value="客服">客服</option>
    </select>

    <label for="name">姓名：</label>
    <select id="name" autocomplete="off"></select>

    <label for="type">打卡項目：</label>
    <select id="type" autocomplete="off">
        <option value="上班">上班</option>
        <option value="下班">下班</option>
        <option value="吃飯">吃飯</option>
        <option value="結束吃飯">結束吃飯</option>
        <option value="休息">休息</option>
        <option value="結束休息">結束休息</option>
        <option value="廁所">廁所</option>
        <option value="抽菸">抽菸</option>
        <option value="返回座位">返回座位</option>
        <option value="事假">事假</option>
        <option value="病假">病假</option>
        <option value="銷假上班">銷假上班</option>
    </select>

    <button id="checkInBtn" onclick="checkIn()">打卡</button>

    <div id="records">
        <h2>打卡記錄 (顯示最近 200 筆)</h2>
        <div id="filterControls">
            <label for="filterGroup">按組別篩選：</label>
            <select id="filterGroup" onchange="loadRecords()"></select>
        </div>
        <button id="exportBtn" onclick="exportToCSV()">匯出報表 (CSV)</button>
        <table>
            <thead>
                <tr>
                    <th>姓名</th>
                    <th>組別</th>
                    <th>項目</th>
                    <th>時間</th>
                    <th>IP 位址</th>
                </tr>
            </thead>
            <tbody id="recordTable"></tbody>
        </table>
    </div>

<script>
    const employees = {
        天狼組: ['曹操 (組長)', '來財', '南風', '胖子', '大飛', '小柒', '馬超'],
        洋天組: ['杜月笙 (組長)', '江海', '馬斯克', '白馬'],
        策天組: ['五條悟 (組長)', '夢子', '安妮亞', '鹿丸', '傑諾', '柳丁'],
        新增: ['紅丸', '冬瓜'],
        客服: ['星空', '森鋒']
    };
    
    // *** ↓↓↓ 請務必將下面的 URL 替換成您最新部署後的 Web App URL ↓↓↓ ***
    const DATABASE_URL = 'https://script.google.com/macros/s/AKfycbzDm81N276SYIzDkEJaFHydg72Kh1OMVShVAjWfLAsh-_Girx625VWNztALr1TDOWiL/exec';

    let recordsPromiseResolver = null;
    function handleData(data) {
        console.log("接收到的後端數據:", JSON.stringify(data, null, 2));
        if (recordsPromiseResolver) {
            recordsPromiseResolver(data);
            recordsPromiseResolver = null;
        }
    }

    async function fetchAndFilterRecords() {
        return new Promise((resolve, reject) => {
            recordsPromiseResolver = (data) => {
                if (data.error) {
                    console.error("後端返回錯誤:", data.error);
                    reject(new Error(data.error));
                    return;
                }
                if (!Array.isArray(data)) {
                    console.error("後端數據格式錯誤，非陣列:", data);
                    reject(new Error("後端數據格式錯誤"));
                    return;
                }
                // 過濾空記錄
                const validRecords = data.filter(record => 
                    record.shift || record.name || record.type || record.time || record.ip
                );
                const selectedGroup = document.getElementById('filterGroup').value;
                const groupFilteredRecords = selectedGroup === '全部' ? validRecords : validRecords.filter(record => record.shift === selectedGroup);
                const reversedRecords = groupFilteredRecords.reverse();
                const finalRecords = reversedRecords.slice(0, 200);
                console.log(`取得 ${validRecords.length} 筆有效資料，顯示最近 ${finalRecords.length} 筆`);
                resolve(finalRecords);
            };
            const script = document.createElement('script');
            script.src = DATABASE_URL;
            script.onerror = () => {
                console.error("JSONP 請求失敗");
                reject(new Error('JSONP 請求失敗'));
            };
            document.body.appendChild(script);
        });
    }

    async function loadRecords() {
        try {
            const records = await fetchAndFilterRecords();
            const recordTable = document.getElementById('recordTable');
            recordTable.innerHTML = '';
            if (!records || records.length === 0) {
                recordTable.innerHTML = '<tr><td colspan="5">無記錄可顯示</td></tr>';
                showMessage('errorMsg', '無記錄可顯示', true);
                return records;
            }
            records.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${record.name || 'N/A'}</td><td>${record.shift || 'N/A'}</td><td>${record.type || 'N/A'}</td><td>${record.time || 'N/A'}</td><td>${record.ip || 'N/A'}</td>`;
                recordTable.appendChild(row);
            });
            return records;
        } catch (error) {
            console.error("載入記錄失敗:", error);
            showMessage('errorMsg', `載入記錄失敗: ${error.message}`, true);
            return [];
        }
    }

    function updateNames() {
        const group = document.getElementById("group").value;
        const nameSelect = document.getElementById("name");
        nameSelect.innerHTML = "";
        employees[group].forEach(name => {
            const option = document.createElement("option");
            option.value = name;
            option.textContent = name;
            nameSelect.appendChild(option);
        });
    }

    function populateFilter() {
        const filterGroup = document.getElementById("filterGroup");
        filterGroup.innerHTML = '<option value="全部">全部</option>';
        Object.keys(employees).forEach(group => {
            const option = document.createElement("option");
            option.value = group;
            option.textContent = group;
            filterGroup.appendChild(option);
        });
    }

    function updateClock() {
        const date = new Date();
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        const formattedTime = `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
        document.getElementById("clock").textContent = `當前時間: ${formattedTime}`;
        return formattedTime;
    }

    function showMessage(id, message, isError = false) {
        const element = document.getElementById(id);
        element.textContent = message;
        element.style.display = "block";
        element.style.color = isError ? "red" : "green";
        setTimeout(() => { element.style.display = "none"; }, 5000);
    }

    async function getIPAddress() {
        const apis = ['https://api.ipify.org?format=json', 'https://ipapi.co/json/', 'https://ipinfo.io/json'];
        for (const api of apis) {
            try {
                const response = await fetch(api, { signal: AbortSignal.timeout(3000) });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                return data.ip || data.query || 'N/A';
            } catch (error) {
                console.warn(`IP API ${api} 失敗: ${error.message}`);
            }
        }
        showMessage('errorMsg', '無法獲取 IP 位址，請檢查網路連線', true);
        return 'N/A';
    }

    async function checkIn() {
        const group = document.getElementById("group").value;
        const name = document.getElementById("name").value;
        const type = document.getElementById("type").value;
        if (!group || !name || !type) {
            showMessage('errorMsg', '請選擇組別、姓名和打卡項目', true);
            return;
        }
        if (!confirm(`確定要為 ${name} 打卡 ${type}？`)) return;
        const time = updateClock(); // 使用 ISO 8601 格式
        const ip = await getIPAddress();
        const data = { shift: group, name: name, type: type, time: time, ip: ip };
        try {
            const response = await fetch(DATABASE_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            console.log("打卡請求發送:", JSON.stringify(data));
            await loadRecords();
            showMessage('successMsg', '打卡成功，已儲存到資料庫');
        } catch (error) {
            console.error('打卡失敗:', error);
            showMessage('errorMsg', `打卡失敗: ${error.message}`, true);
        }
    }

    async function exportToCSV() {
        const records = await loadRecords();
        if (records.length === 0) {
            showMessage('errorMsg', '無記錄可匯出', true);
            return;
        }
        const headers = ['姓名', '組別', '項目', '時間', 'IP 位址'];
        const csv = [headers.join(',')];
        records.forEach(record => {
            const row = [`"${record.name || 'N/A'}"`, `"${record.shift || 'N/A'}"`, `"${record.type || 'N/A'}"`, `"${record.time || 'N/A'}"`, `"${record.ip || 'N/A'}"`];
            csv.push(row.join(','));
        });
        const csvContent = csv.join('\n');
        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        const date = new Date().toLocaleDateString('zh-TW', { timeZone: 'Asia/Taipei' }).replace(/\//g, '-');
        link.href = url;
        link.download = `潤森鑫_打卡記錄_${date}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
    }

    function startAutoRefresh() {
        setInterval(() => {
            if (document.visibilityState === 'visible') {
                loadRecords();
            }
        }, 30000);
    }

    updateNames();
    populateFilter();
    setInterval(updateClock, 1000);
    updateClock();
    loadRecords();
    startAutoRefresh();
</script>
</body>
</html>